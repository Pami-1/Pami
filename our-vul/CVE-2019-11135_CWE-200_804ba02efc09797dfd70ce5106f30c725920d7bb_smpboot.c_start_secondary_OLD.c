void start_secondary(void *unused)
{
    



    unsigned int cpu = booting_cpu;

    

    set_processor_id(cpu);
    set_current(idle_vcpu[cpu]);
    this_cpu(curr_vcpu) = idle_vcpu[cpu];
    rdmsrl(MSR_EFER, this_cpu(efer));
    init_shadow_spec_ctrl_state();

    















    spin_debug_disable();

    get_cpu_info()->use_pv_cr3 = false;
    get_cpu_info()->xen_cr3 = 0;
    get_cpu_info()->pv_cr3 = 0;

    load_system_tables();

    

    
    write_cr4(mmu_cr4_features);

    percpu_traps_init();

    cpu_init();

    initialize_cpu_data(cpu);

    if ( system_state <= SYS_STATE_smp_boot )
        early_microcode_update_cpu(false);
    else
        microcode_resume_cpu(cpu);

    




    if ( boot_cpu_has(X86_FEATURE_IBRSB) )
        wrmsrl(MSR_SPEC_CTRL, default_xen_spec_ctrl);

    if ( xen_guest )
        hypervisor_ap_setup();

    smp_callin();

    init_percpu_time();

    setup_secondary_APIC_clock();

    



    flush_tlb_local();

    
    spin_debug_enable();
    set_cpu_sibling_map(cpu);
    notify_cpu_starting(cpu);
    wmb();

    




    lock_vector_lock();
    setup_vector_irq(cpu);
    cpumask_set_cpu(cpu, &cpu_online_map);
    unlock_vector_lock();

    
    local_irq_enable();
    mtrr_ap_init();

    wmb();
    startup_cpu_idle_loop();
}