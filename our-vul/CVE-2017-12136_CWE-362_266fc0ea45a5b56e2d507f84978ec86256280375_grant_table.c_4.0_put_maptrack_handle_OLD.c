static inline void
put_maptrack_handle(
    struct grant_table *t, int handle)
{
    struct domain *currd = current->domain;
    struct vcpu *v;
    unsigned int prev_tail, cur_tail;

    
    maptrack_entry(t, handle).ref = MAPTRACK_TAIL;

    
    v = currd->vcpu[maptrack_entry(t, handle).vcpu];

    cur_tail = read_atomic(&v->maptrack_tail);
    do {
        prev_tail = cur_tail;
        cur_tail = cmpxchg(&v->maptrack_tail, prev_tail, handle);
    } while ( cur_tail != prev_tail );

    
    write_atomic(&maptrack_entry(t, prev_tail).ref, handle);
}