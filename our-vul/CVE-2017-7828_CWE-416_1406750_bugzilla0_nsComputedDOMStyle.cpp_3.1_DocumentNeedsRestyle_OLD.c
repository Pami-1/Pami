static bool
DocumentNeedsRestyle(const nsIDocument* aDocument, Element* aElement)
{
  nsIPresShell* shell = aDocument->GetShell();
  if (!shell) {
    return true;
  }
  
  
  StyleSetHandle styleSet = shell->StyleSet();
  if (styleSet->StyleSheetsHaveChanged()) {
    return true;
  }
  
  nsPresContext* context = shell->GetPresContext();
  if (context->EffectCompositor()->HasPendingStyleUpdatesFor(aElement)) {
    return true;
  }
  if (styleSet->IsServo()) {
    
    
    
    ServoRestyleManager* restyleManager = context->RestyleManager()->AsServo();
    restyleManager->ProcessAllPendingAttributeAndStateInvalidations();

    
    
    
    
    
    if (aDocument->GetServoRestyleRoot() &&
        restyleManager->HasPendingRestyleAncestor(aElement)) {
      return true;
    }
  } else {
    
    
    GeckoRestyleManager* restyleManager = context->RestyleManager()->AsGecko();
    if (restyleManager->HasPendingRestyles() && ContentNeedsRestyle(aElement)) {
      return true;
    }
  }
  return false;
}