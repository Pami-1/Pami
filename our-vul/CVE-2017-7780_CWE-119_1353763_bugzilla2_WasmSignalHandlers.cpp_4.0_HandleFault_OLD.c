static bool
HandleFault(PEXCEPTION_POINTERS exception)
{
    EXCEPTION_RECORD* record = exception->ExceptionRecord;
    CONTEXT* context = exception->ContextRecord;

    if (record->ExceptionCode != EXCEPTION_ACCESS_VIOLATION)
        return false;

    uint8_t** ppc = ContextToPC(context);
    uint8_t* pc = *ppc;

    if (record->NumberParameters < 2)
        return false;

    
    JSContext* cx = TlsContext.get();
    if (!cx || cx->handlingSegFault)
        return false;
    AutoSetHandlingSegFault handling(cx);

    WasmActivation* activation = cx->wasmActivationStack();
    if (!activation)
        return false;

    Code* code = activation->compartment()->wasm.lookupCode(pc);
    if (!code)
        return false;

    if (!code->segment().containsFunctionPC(pc)) {
        
        
        
        
        
        
        
        
        
        return pc == code->segment().interruptCode() &&
               code->segment().containsFunctionPC(activation->resumePC());
    }

    const Instance* instance = LookupFaultingInstance(activation, pc, ContextToFP(context));
    if (!instance)
        return false;

    uint8_t* faultingAddress = reinterpret_cast<uint8_t*>(record->ExceptionInformation[1]);

    
    
    if (!IsHeapAccessAddress(*instance, faultingAddress))
        return false;

    HandleMemoryAccess(context, pc, faultingAddress, *instance, ppc);
    return true;
}