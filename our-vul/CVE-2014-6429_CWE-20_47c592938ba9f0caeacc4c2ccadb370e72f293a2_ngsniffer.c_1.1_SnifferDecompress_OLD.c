static int
SnifferDecompress(unsigned char *inbuf, size_t inlen, unsigned char *outbuf,
		  size_t outlen, int *err)
{
	unsigned char * pin  = inbuf;
	unsigned char * pout = outbuf;
	unsigned char * pin_end  = pin + inlen;
	unsigned char * pout_end = pout + outlen;
	unsigned int bit_mask;      
	unsigned int bit_value = 0; 
	unsigned int code_type;     
	unsigned int code_low;      
	int length;		    
	int offset;		    

	if (inlen > G_MAXUINT16) {
		return ( -1 );
	}

	bit_mask  = 0;  
	while (1)
	{
		
		bit_mask = bit_mask >> 1;

		
		if ( 0 == bit_mask )
		{
			bit_mask  = 0x8000;  
			bit_value = pletoh16(pin);   
			pin += 2;          
			if ( pin >= pin_end )
			{
				*err = WTAP_ERR_UNC_TRUNCATED;	 
				return ( -1 );
			}
		}

		
		if ( !(bit_mask & bit_value) )
		{
			
			*(pout++) = *(pin++);
		}
		else
		{
			


			code_type = (unsigned int) ((*pin) >> 4 ) & 0xF;
			code_low  = (unsigned int) ((*pin) & 0xF );
			pin++;   
			if ( pin >= pin_end )
			{
				*err = WTAP_ERR_UNC_TRUNCATED;	 
				return ( -1 );
			}

			
			switch ( code_type )
			{
			case 0  :   
				




				length = code_low + 3;
				
				if ( pout + length > pout_end )
				{
					*err = WTAP_ERR_UNC_OVERFLOW;
					return ( -1 );
				}

				
				memset( pout, *pin++, length );
				pout += length;
				break;
			case 1  :   
				






				length = code_low + ((unsigned int)(*pin++) << 4) + 19;
				

				if ( pin >= pin_end )
				{
					*err = WTAP_ERR_UNC_TRUNCATED;	 
					return ( -1 );
				}
				
				if ( pout + length > pout_end )
				{
					*err = WTAP_ERR_UNC_OVERFLOW;
					return ( -1 );
				}

				
				memset( pout, *pin++, length );
				pout += length;
				break;
			case 2  :   
				






				offset = code_low + ((unsigned int)(*pin++) << 4) + 3;
				

				if ( pin >= pin_end )
				{
					*err = WTAP_ERR_UNC_TRUNCATED;	 
					return ( -1 );
				}
				
				if ( pout - offset < outbuf )
				{
					*err = WTAP_ERR_UNC_BAD_OFFSET;
					return ( -1 );
				}

				
				length = (unsigned int)(*pin++) + 16;
				if ( pout + length > pout_end )
				{
					*err = WTAP_ERR_UNC_OVERFLOW;
					return ( -1 );
				}

				

				memcpy( pout, pout - offset, length );
				pout += length;
				break;
			default :   
				






				offset = code_low + ((unsigned int)(*pin++) << 4) + 3;
				
				if ( pout - offset < outbuf )
				{
					*err = WTAP_ERR_UNC_BAD_OFFSET;
					return ( -1 );
				}

				
				length = code_type;
				if ( pout + length > pout_end )
				{
					*err = WTAP_ERR_UNC_OVERFLOW;
					return ( -1 );
				}

				

				memcpy( pout, pout - offset, length );
				pout += length;
				break;
			}
		}

		
		if ( pin >= pin_end )
			break;
	}

	return (int) ( pout - outbuf );  
}