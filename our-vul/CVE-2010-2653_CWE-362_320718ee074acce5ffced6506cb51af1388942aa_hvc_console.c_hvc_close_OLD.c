static void hvc_close(struct tty_struct *tty, struct file * filp)
{
	struct hvc_struct *hp;
	unsigned long flags;

	if (tty_hung_up_p(filp))
		return;

	




	if (!tty->driver_data)
		return;

	hp = tty->driver_data;

	spin_lock_irqsave(&hp->lock, flags);
	tty_kref_get(tty);

	if (--hp->count == 0) {
		
		hp->tty = NULL;
		spin_unlock_irqrestore(&hp->lock, flags);

		
		tty_kref_put(tty);

		if (hp->ops->notifier_del)
			hp->ops->notifier_del(hp, hp->data);

		
		cancel_work_sync(&hp->tty_resize);

		




		tty_wait_until_sent(tty, HVC_CLOSE_WAIT);
	} else {
		if (hp->count < 0)
			printk(KERN_ERR "hvc_close %X: oops, count is %d\n",
				hp->vtermno, hp->count);
		spin_unlock_irqrestore(&hp->lock, flags);
	}

	tty_kref_put(tty);
	kref_put(&hp->kref, destroy_hvc_struct);
}