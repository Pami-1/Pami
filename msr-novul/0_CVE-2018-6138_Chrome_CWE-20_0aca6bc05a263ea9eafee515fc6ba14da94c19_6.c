bool PermissionsData::CanCaptureVisiblePage(int tab_id,
bool PermissionsData::CanCaptureVisiblePage(const GURL& document_url,
                                            const Extension* extension,
                                            int tab_id,
                                             std::string* error) const {
  bool has_active_tab = false;
  {
    base::AutoLock auto_lock(runtime_lock_);
    const PermissionSet* tab_permissions = GetTabSpecificPermissions(tab_id);
    has_active_tab = tab_permissions &&
                     tab_permissions->HasAPIPermission(APIPermission::kTab);
  }
  
  
  
  
  
  
  
  if (GetPageAccess(extension, document_url, tab_id, error) != ACCESS_ALLOWED) {
    if (!document_url.SchemeIs(content::kChromeUIScheme))
      return false;

    
    
    
    
    
    if (has_active_tab)
      return true;

    if (error)
      *error = manifest_errors::kActiveTabPermissionNotGranted;

    return false;
  }

   const URLPattern all_urls(URLPattern::SCHEME_ALL,
                             URLPattern::kAllUrlsPattern);
 
   base::AutoLock auto_lock(runtime_lock_);
   if (active_permissions_unsafe_->explicit_hosts().ContainsPattern(all_urls))
     return true;
 
  const PermissionSet* tab_permissions = GetTabSpecificPermissions(tab_id);
  if (tab_permissions &&
      tab_permissions->HasAPIPermission(APIPermission::kTab)) {
    return true;
   }
 
   if (error)
    *error = manifest_errors::kAllURLOrActiveTabNeeded;
  return false;
}